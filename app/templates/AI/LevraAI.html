{% extends "layout.html" %}
{% block style %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-VO2U6U3+6mY8O5X+0lX8c3B9MJbZ0JqVbC8bUoF5Vx7+0s0V1kz5oZjFzRtX8nMp" crossorigin="anonymous">

<!-- Optional: Bootstrap JS + Popper (for components like dropdowns, modals) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-QJHtvGhmr9b8FvVPrzQZPTh2iYB0qsnK2lP+5Jg6nkaFqjtR91E4uLkQBs1mD/Z+" crossorigin="anonymous"></script>

<style>
  :root {
    --bg-1: #020617;
    --bg-2: #00102a;
    --neon: #00c2ff;
    --neon-2: #4de0ff;
    --glass: rgba(255,255,255,0.04);
    --muted: rgba(255,255,255,0.65);
    --radius-lg: 18px;
    color-scheme: dark;
  }
  * { box-sizing: border-box; }
  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Inter', system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
    color: #eaf6ff;
    background: linear-gradient(180deg,var(--bg-1) 0%, var(--bg-2) 60%);
    -webkit-font-smoothing: antialiased;
    overflow: hidden;
  }
.messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px 30px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-height: 0; /* allows flex scroll */
  }
  .wrap {
    display: grid;
    grid-template-columns: 280px 1fr;
    height: 100vh;
    width: 100vw;
  }

  /* Sidebar */
  .sidebar {
    background: linear-gradient(180deg, rgba(0,18,38,0.35), rgba(0,6,16,0.2));
    border-right: 1px solid rgba(255,255,255,0.05);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto;
  }
  .brand {
    display: flex; align-items: center; gap: 12px;
  }
  .logo {
    width: 42px; height: 42px; border-radius: 10px;
    display: grid; place-items: center;
    background: radial-gradient(circle at 30% 20%, var(--neon-2), transparent 25%),
                linear-gradient(135deg,#00182b,#002b40);
    box-shadow: 0 0 16px rgba(0,194,255,0.12) inset;
  }
  .brand h1 { font-size: 15px; margin: 0; color: var(--neon); }
  .brand p { margin: 0; font-size: 11px; color: var(--muted); }

  .convo-list {
    flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px;
  }
  .convo {
    padding: 10px; border-radius: 10px;
    display: flex; gap: 8px; align-items: center;
    cursor: pointer; transition: all .18s;
  }
  .convo:hover { background: rgba(255,255,255,0.05); }
  .convo .meta .title { font-size: 14px; font-weight: 600; color: #dff7ff; }
  .convo .meta .sub { font-size: 12px; color: var(--muted); }

  /* Main Chat */
  .main {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden; /* ensures children layout correctly */
}
/* Sidebar convo list stays scrollable */
.convo-list {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-height: 0; /* critical for flex children */
}

/* Messages area scrollable */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px 30px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-height: 0; /* allows flex scroll */
}

/* Composer floats */
.composer {
  
  bottom: 0;
  left: 280px;   /* same as sidebar width */
  right: 0;
  padding: 16px 20px;
  display: flex;
  gap: 12px;
  align-items: center;
  z-index: 100; /* above chat messages */
}

/* Mobile: sidebar hidden so input spans full width */
@media (max-width: 880px) {
  .composer {
    left: 0;
  }
}


  .bubble {
    max-width: 750px;
    padding: 14px 18px;
    border-radius: 12px;
    line-height: 1.5;
  }
  .bubble.user {
    margin-left: auto;
    background: linear-gradient(180deg, rgba(0,194,255,0.06), rgba(0,194,255,0.02));
    border: 1px solid rgba(0,194,255,0.12);
  }
  .bubble.ai {
    margin-right: auto;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid rgba(255,255,255,0.08);
  }

  /* Input */
  .composer {
    padding: 187px 45px;
    padding-top: 10px;
    display: flex; gap: 12px; align-items: center;
  }
  .input {
    flex: 1; display: flex; align-items: center;
    background: rgba(255,255,255,0.05);
    padding: 8px 12px;
    border-radius: 10px;
  }
  .input textarea {
    width: 100%; resize: none; border: 0;
    background: transparent; color: inherit;
    font-size: 14px; outline: none;
    height: 40px;
  }
  .icon-btn {
    width: 42px; height: 42px;
    border-radius: 8px;
    display: grid; place-items: center;
    border: 1px solid rgba(255,255,255,0.05);
    background: transparent;
    cursor: pointer;
    color: var(--neon);
  }

  @media (max-width: 880px) {
    .wrap { grid-template-columns: 1fr; }
    .sidebar { display: none; }
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">ðŸ¤–</div>
      <div>
        <h1 style="color: var(--neon)">Levra AI</h1>
        <p style="color: var(--muted); font-size: 12px;">personal assistant â€¢ beta</p>
      </div>
    </div>
    <div class="controls" style="margin-bottom: 18px;">
      <button class="btn btn-outline-info btn-sm mb-2">+ New</button>
      <button class="btn btn-outline-info btn-sm">Export</button>
    </div>
    <!-- Conversation List -->
    <div class="convo-list">
      <div class="convo"><i class="bi bi-play-circle-fill"></i>
        <div class="meta"><div class="title">Assist Mode</div><div class="sub">Quick answers</div></div>
      </div>
      <div class="convo"><i class="bi bi-cpu-fill"></i>
        <div class="meta"><div class="title">Forge Mode</div><div class="sub">Train & learn</div></div>
      </div>
    </div>
  </aside>

  <!-- Main Chat -->
  <main class="main">
    <section class="messages" id="messages">
      <!-- Message bubbles will be appended here -->
    </section>
    <div class="composer">
      <div class="input">
        <textarea placeholder="Type a message..." rows="1" id="input"></textarea>
      </div>
      <button class="icon-btn" id="send" onclick="sendMessage()">âž¤</button>
    </div>
    
  </main>
</div>
{% endblock %}


{% block bottomscript %}
<script>
// Escape HTML helper
function escapeHtml(s){
    return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

// Append bubble with optional typing animation for AI
function appendBubble(text, who='ai') {
    const $wrap = $('<div>').addClass('bubble ' + who);
    const $textDiv = $('<div>');
    const $meta = $('<div>').addClass('meta-line').text();
    $wrap.append($textDiv).append($meta);
    $('#messages').append($wrap);
    $('#messages').scrollTop($('#messages')[0].scrollHeight);

    if (who === 'ai') {
        // Typing animation
        let i = 0;
        const interval = setInterval(() => {
            $textDiv.html(escapeHtml(text.substring(0, i)).replace(/\n/g, '<br>'));
            i++;
            if (i > text.length) clearInterval(interval);
            $('#messages').scrollTop($('#messages')[0].scrollHeight);
        }, 30);
    } else {
        $textDiv.html(escapeHtml(text).replace(/\n/g, '<br>'));
    }
}

function sendMessage() {
    const $input = $('#input');
    const v = $input.val().trim();
    if (!v) return;
    appendBubble(v, 'user');
    $input.val('');

    setTimeout(() => {
        $.ajax({
            url: '/levra/response',
            method: 'POST',       // ensure Flask route allows POST
            data: { message: v },
            success: function(data){
                // data is already a JS object
                console.log("Response from server:", data);
                appendBubble(data.content, 'ai');
            },
            error: function(err){
                appendBubble("Error getting response from server.", 'ai');
                console.error(err);
            }
        });
    }, 600 + Math.random() * 800);
}


// jQuery DOM ready
$(function() {
    $('footer').hide();

    const $messages = $('#messages');
    const $input = $('#input');
    const $send = $('#send');
    const $clear = $('#clear');
    const $glow = $('#glow');

    // initial AI message
    appendBubble("ðŸ‘‹ Hey â€” Iâ€™m your personal AI. Ask me anything!", 'ai');

    // Event bindings
    $send.on('click', sendMessage);
    $input.on('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    $clear.on('click', function() {
        $messages.html('');
        appendBubble("Cleared chat. Ask me something new!", 'ai');
    });
    $glow.on('input', function() {
        const v = $(this).val();
        $('.chat-card').css('box-shadow', `0 30px ${20 + Number(v)}px rgba(0,194,255,0.06), 0 0 ${120 + v*4}px rgba(0,194,255,0.04) inset`);
    });

    // accessibility focus
    $(window).on('load', () => $messages.focus());
    $(window).on('keydown', function(e) {
        if (e.key === '/' && document.activeElement !== $input[0]) {
            e.preventDefault();
            $input.focus();
        }
    });
});

</script>

{% endblock %}